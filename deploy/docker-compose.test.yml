services:
  # KIDON GUARD (Process Monitor)
  kidon:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.kidon
    container_name: kidon-guard
    privileged: true
    pid: "host"
    cap_add:
      - SYS_ADMIN
      - SYS_PTRACE
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug:rw
      - /sys/kernel/tracing:/sys/kernel/tracing:rw
    command: >
      /bin/sh -c "
        echo 'ðŸ›¡ï¸ Preparing Kidon Guard...' &&
        mount -t debugfs none /sys/kernel/debug 2>/dev/null || true &&
        mount -t tracefs none /sys/kernel/tracing 2>/dev/null || true &&
        echo 'ðŸ”¥ Starting Process Guard v0.1.0...' &&
        /app/kidon guard
      "
    networks:
      - test-net

  # TEST: Process Execution Detection
  test-bash:
    image: ubuntu:22.04
    container_name: test-bash
    depends_on:
      - kidon
    command: >
      /bin/sh -c "
        echo 'ðŸŽ¯ Starting test...' &&
        sleep 10 &&
        echo 'ðŸ’€ Attempting bash...' &&
        /bin/bash -c 'echo BASH EXECUTED' &&
        echo 'âœ… Test Complete'
      "
    networks:
      - test-net

networks:
  test-net:
    driver: bridge
