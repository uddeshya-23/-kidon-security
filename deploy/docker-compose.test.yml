services:
  # The Victim: Ubuntu with bash - tries to spawn shell after delay
  victim:
    image: ubuntu:22.04
    container_name: victim-agent
    depends_on:
      - kidon
    command: >
      /bin/sh -c "
        echo 'ðŸŽ¯ Victim agent starting...' &&
        sleep 10 &&
        echo 'ðŸ’€ Attempting to spawn bash shell...' &&
        /bin/bash -c 'echo I AM HACKED - bash executed successfully' &&
        sleep 5
      "
    networks:
      - kidon-net

  # The Police: Kidon Guard with eBPF
  kidon:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.kidon
    container_name: kidon-guard
    privileged: true
    pid: "host"
    cap_add:
      - SYS_ADMIN
      - SYS_PTRACE
      - NET_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug:rw
      - /sys/kernel/tracing:/sys/kernel/tracing:rw
      - /sys/fs/bpf:/sys/fs/bpf:rw
    command: >
      /bin/sh -c "
        echo 'ðŸ›¡ï¸ Preparing Kidon Guard...' &&
        mount -t debugfs none /sys/kernel/debug 2>/dev/null || true &&
        mount -t tracefs none /sys/kernel/tracing 2>/dev/null || true &&
        echo 'ðŸ”’ Starting eBPF protection...' &&
        /app/kidon guard
      "
    networks:
      - kidon-net

networks:
  kidon-net:
    driver: bridge
